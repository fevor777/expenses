import{$ as M,Aa as z,Ba as U,Ca as b,D as o,Da as T,E as x,Ea as k,F as C,G as m,H as p,Ha as J,Ia as K,J as a,K as c,Ka as Q,L as d,La as W,M as H,Ma as w,N as h,O as u,Q as l,R as V,S as D,T as N,Z as E,a as j,ea as R,fa as X,i as P,ia as L,j as O,ja as $,k as f,l as A,n as F,q as Y,r as S,v,w as _,wa as G,xa as q}from"./chunk-5U2HUSPZ.js";import{a as y,b as g}from"./chunk-MZBEQE75.js";function te(n,e){n&1&&(a(0,"div",5)(1,"span"),l(2,"\u0414\u043B\u044F \u044D\u0442\u0438\u0445 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439 \u0438 \u043F\u0435\u0440\u0438\u043E\u0434\u0430 \u0442\u0440\u0430\u0442 \u043D\u0435\u0442"),c()())}function ie(n,e){if(n&1&&(a(0,"span")(1,"span"),l(2),E(3,"date"),c(),a(4,"span"),l(5),c()()),n&2){let t=u().$implicit,i=u();p("background","#f8d7da")("width","100%")("display","block"),o(2),D("",M(3,10,t.date,"dd-MM-YYYY")," - "),o(2),p("font-weight","600"),o(),D("",i.getTotalAmountPerDay(t.date),"\u20AC")}}function ne(n,e){if(n&1){let t=H();a(0,"span",10),h("click",function(){v(t);let s=u().index,r=u();return _(r.onDeleteFromBalance(s))}),l(1," | Delete from balance"),c()}n&2&&p("color","grey")("cursor","pointer")}function re(n,e){if(n&1){let t=H();a(0,"span"),C(1,ie,6,13,"span",6),a(2,"div",7),d(3,"br"),l(4,"\u0426\u0435\u043D\u0430: "),a(5,"span"),l(6),c(),d(7,"br")(8,"br"),a(9,"div"),l(10," Category: "),a(11,"span",8),h("click",function(){let s=v(t).$implicit,r=u();return _(r.filterByCategory(s.category))}),l(12),c(),a(13,"i",9),h("click",function(){let s=v(t).$implicit,r=u();return _(r.navigateToChart(s.category))}),c()(),l(14),E(15,"date"),E(16,"date"),d(17,"br")(18,"br"),a(19,"span",10),h("click",function(){let s=v(t).index,r=u();return _(r.onDelete(s))}),l(20,"Delete"),c(),C(21,ne,2,4,"span",11),c(),d(22,"hr"),c()}if(n&2){let t=e.$implicit,i=u();o(),m("ngIf",t.showDateTitle),o(4),p("color","#ff6f61"),o(),D("",t.amount,"\u20AC"),o(6),V(i.getCategoryNameByIdFunc(t.category)),o(2),N(" Date: ",M(15,16,t.date,"HH:mm")," (",M(16,19,t.date,"dd-MM-YYYY"),")"),o(5),p("color","grey")("cursor","pointer"),o(2),m("ngIf",!t.isDeletedFromBalance&&i.getCategoryByIdFunc(t.category).includeInBalance),o(),p("background","#f8d7da")("height","2px")}}var B=class n{constructor(e,t,i,s){this.router=e;this.expenseService=t;this.balanceService=i;this.dateFilterService=s}expenses=[];totalAmount=0;temporaryDate=0;totalAmountPerDays=new Map;getCategoryByIdFunc=k;defaultFilter={categories:[],date:void 0};currentFilter={categories:[],date:void 0};getCategoryNameByIdFunc=T;destroySubject=new j;ngOnInit(){this.dateFilterService.dateFilter&&(this.defaultFilter=g(y({},this.defaultFilter),{date:this.dateFilterService.dateFilter}),this.dateFilterService.dateFilter=void 0);let e=this.dateFilterService.categories;Array.isArray(e)&&e.length>0&&(this.defaultFilter=g(y({},this.defaultFilter),{categories:e}),this.dateFilterService.categories=void 0),this.defaultFilter?.date||this.defaultFilter?.categories?.length>0?this.applyFilters(this.defaultFilter):this.initiateExpenses().pipe(P(),f(this.destroySubject)).subscribe(()=>{this.sumValues()})}initiateExpenses(){return this.expenseService.getExpenses().pipe(A(e=>{this.expenses=e.map(t=>{let i=this.isDatePanelVisible(t.date);if(i)this.totalAmountPerDays.set(t.date,t.amount);else{let s=this.totalAmountPerDays.get(this.temporaryDate)||0,r=Math.round((s+t.amount)*100)/100;this.totalAmountPerDays.set(this.temporaryDate,r)}return g(y({},t),{showDateTitle:i})})}))}navigateToChart(e){this.dateFilterService.categories=[e],this.dateFilterService.dateFilter=this.currentFilter?.date,this.router.navigate(["/details"],{queryParams:{"back-url":"/history"}})}getCategoryFilters(){return this.defaultFilter?.categories.map(T).join(", ")}applyFilters(e){this.currentFilter=y({},e||{categories:[],date:void 0}),this.initiateExpenses().pipe(P(),f(this.destroySubject)).subscribe(()=>{e?.categories.length>0&&(this.expenses=this.expenses.filter(t=>e?.categories.includes(t.category))),e?.date&&(this.expenses=Q(this.expenses,e?.date?.start,e?.date?.finish)),this.sumValues()})}filterByCategory(e){this.defaultFilter=g(y({},this.currentFilter),{categories:[e]}),this.applyFilters(this.defaultFilter)}getTotalAmountPerDay(e){return this.totalAmountPerDays.get(e)||0}onDelete(e){if(confirm("Delete?")){this.updateBalance(e);let t=this.expenses[e].id;this.expenseService.deleteExpense(t).pipe(O(()=>this.initiateExpenses()),f(this.destroySubject)).subscribe(()=>this.sumValues())}}updateBalance(e,t){let i=Number(localStorage.getItem("balance"))||0,s=k(this.expenses[e].category);if(i&&!this.expenses[e]?.isDeletedFromBalance&&s?.includeInBalance){let r=Math.round((i+this.expenses[e].amount)*100)/100;this.balanceService.addBalance(r).pipe(f(this.destroySubject)).subscribe()}t&&(this.expenses[e].isDeletedFromBalance=t,this.expenseService.updateExpense(this.expenses[e]).pipe(f(this.destroySubject)).subscribe())}onDeleteFromBalance(e){confirm("Return to balance?")&&this.updateBalance(e,!0)}onSwipeRight(){this.router.navigate(["/"])}isDatePanelVisible(e){return this.temporaryDate===0?(this.temporaryDate=e,!0):new Date(this.temporaryDate).toDateString()===new Date(e).toDateString()?!1:(this.temporaryDate=e,!0)}touchStartX=0;touchStartY=0;touchEndX=0;touchEndY=0;onTouchStart(e){this.touchStartX=e.changedTouches[0].screenX,this.touchStartY=e.changedTouches[0].screenY}onTouchEnd(e){this.touchEndX=e.changedTouches[0].screenX,this.touchEndY=e.changedTouches[0].screenY,this.handleSwipeGesture()}handleSwipeGesture(){let e=this.touchEndX-this.touchStartX,t=this.touchEndY-this.touchStartY;Math.abs(e)>Math.abs(t)&&(e>100?this.onSwipeRight():e<-100&&this.onSwipeLeft())}onSwipeLeft(){this.router.navigate(["/statistics"])}ngOnDestroy(){this.destroySubject.next(),this.destroySubject.complete()}sumValues(){this.totalAmount=this.expenses.reduce((e,t)=>{let i=e+t.amount;return Math.round(i*100)/100},0)}static \u0275fac=function(t){return new(t||n)(x(z),x(J),x(K),x(W))};static \u0275cmp=Y({type:n,selectors:[["app-history"]],hostBindings:function(t,i){t&1&&h("touchstart",function(r){return i.onTouchStart(r)})("touchend",function(r){return i.onTouchEnd(r)})},decls:8,vars:13,consts:[[1,"history-container"],[3,"routerLink"],[3,"selectedFilters","value","totalAmount"],["class","history-empty",4,"ngIf"],[4,"ngFor","ngForOf"],[1,"history-empty"],[3,"background","width","display",4,"ngIf"],[1,"history-item"],[1,"app-link",3,"click"],[1,"fas","fa-chart-bar","history-item-chart",3,"click"],[3,"click"],[3,"color","cursor","click",4,"ngIf"]],template:function(t,i){t&1&&(a(0,"div",0)(1,"span",1),l(2,"< Back"),c(),d(3,"br"),a(4,"app-multi-filter",2),h("selectedFilters",function(r){return i.applyFilters(r)}),c(),d(5,"hr"),C(6,te,3,0,"div",3)(7,re,23,22,"span",4),c()),t&2&&(o(),p("color","blue")("cursor","pointer"),m("routerLink","/"),o(3),m("value",i.defaultFilter)("totalAmount",i.totalAmount),o(),p("background","#f8d7da")("height","2px"),o(),m("ngIf",!i.expenses.length),o(),m("ngForOf",i.expenses))},dependencies:[U,R,X,w,L],styles:[".history-container[_ngcontent-%COMP%]{height:100dvh;overflow-y:scroll}.history-container[_ngcontent-%COMP%]   .history-item[_ngcontent-%COMP%]{padding-left:10px}.history-container[_ngcontent-%COMP%]   .history-container-top[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:0 1rem 0 0}.history-container[_ngcontent-%COMP%]   .history-empty[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;font-family:Montserrat,sans-serif;color:#000}.history-container[_ngcontent-%COMP%]   .history-item-chart[_ngcontent-%COMP%]{padding:15px 15px 0 25px;font-size:15px;color:gray}"]})};var oe=[{path:"",component:B}],I=class n{static \u0275fac=function(t){return new(t||n)};static \u0275mod=S({type:n});static \u0275inj=F({imports:[b.forChild(oe),b]})};var ee=class n{static \u0275fac=function(t){return new(t||n)};static \u0275mod=S({type:n});static \u0275inj=F({imports:[b,I,$,G,q,w]})};export{ee as HistoryModule};
