import{$ as M,Aa as U,Ba as z,Ca as b,D as r,Da as T,E as v,Ea as j,F as D,G as m,H as p,Ha as J,Ia as K,J as a,K as c,Ka as Q,L as d,La as W,M as P,Ma as w,N as y,O as u,Q as l,R as V,S as F,T as N,Z as E,a as k,ea as R,fa as X,i as H,ia as L,j as A,ja as $,k as h,l as O,n as x,q as Y,r as _,v as S,w as C,wa as G,xa as q}from"./chunk-7REL2VKR.js";import{a as f,b as g}from"./chunk-MZBEQE75.js";function te(n,e){n&1&&(a(0,"div",5)(1,"span"),l(2,"\u0414\u043B\u044F \u044D\u0442\u0438\u0445 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439 \u0438 \u043F\u0435\u0440\u0438\u043E\u0434\u0430 \u0442\u0440\u0430\u0442 \u043D\u0435\u0442"),c()())}function ie(n,e){if(n&1&&(a(0,"span")(1,"span"),l(2),E(3,"date"),c(),a(4,"span"),l(5),c()()),n&2){let t=u().$implicit,i=u();p("background","#f8d7da")("width","100%")("display","block"),r(2),F("",M(3,10,t.date,"dd-MM-YYYY")," - "),r(2),p("font-weight","600"),r(),F("",i.getTotalAmountPerDay(t.date),"\u20AC")}}function ne(n,e){if(n&1){let t=P();a(0,"span",9),y("click",function(){S(t);let s=u().index,o=u();return C(o.onDeleteFromBalance(s))}),l(1," | Delete from balance"),c()}n&2&&p("color","grey")("cursor","pointer")}function re(n,e){if(n&1){let t=P();a(0,"span"),D(1,ie,6,13,"span",6),a(2,"div",7),d(3,"br"),l(4,"\u0426\u0435\u043D\u0430: "),a(5,"span"),l(6),c(),d(7,"br")(8,"br"),a(9,"div"),l(10," Category: "),a(11,"span",8),y("click",function(){let s=S(t).$implicit,o=u();return C(o.filterByCategory(s.category))}),l(12),c()(),l(13),E(14,"date"),E(15,"date"),d(16,"br")(17,"br"),a(18,"span",9),y("click",function(){let s=S(t).index,o=u();return C(o.onDelete(s))}),l(19,"Delete"),c(),D(20,ne,2,4,"span",10),c(),d(21,"hr"),c()}if(n&2){let t=e.$implicit,i=u();r(),m("ngIf",t.showDateTitle),r(4),p("color","#ff6f61"),r(),F("",t.amount,"\u20AC"),r(6),V(i.getCategoryNameByIdFunc(t.category)),r(),N(" Date: ",M(14,16,t.date,"HH:mm")," (",M(15,19,t.date,"dd-MM-YYYY"),")"),r(5),p("color","grey")("cursor","pointer"),r(2),m("ngIf",!t.isDeletedFromBalance&&i.getCategoryByIdFunc(t.category).includeInBalance),r(),p("background","#f8d7da")("height","2px")}}var B=class n{constructor(e,t,i,s){this.router=e;this.expenseService=t;this.balanceService=i;this.dateFilterService=s}expenses=[];totalAmount=0;temporaryDate=0;totalAmountPerDays=new Map;getCategoryByIdFunc=j;filter={categories:[],date:void 0};getCategoryNameByIdFunc=T;destroySubject=new k;ngOnInit(){this.dateFilterService.dateFilter&&(this.filter=g(f({},this.filter),{date:this.dateFilterService.dateFilter}),this.dateFilterService.dateFilter=void 0);let e=this.dateFilterService.categories;Array.isArray(e)&&e.length>0&&(this.filter=g(f({},this.filter),{categories:e}),this.dateFilterService.categories=void 0),this.filter?.date||this.filter?.categories?.length>0?this.applyFilters(this.filter):this.initiateExpenses().pipe(H(),h(this.destroySubject)).subscribe(()=>{this.sumValues()})}initiateExpenses(){return this.expenseService.getExpenses().pipe(O(e=>{this.expenses=e.map(t=>{let i=this.isDatePanelVisible(t.date);if(i)this.totalAmountPerDays.set(t.date,t.amount);else{let s=this.totalAmountPerDays.get(this.temporaryDate)||0,o=Math.round((s+t.amount)*100)/100;this.totalAmountPerDays.set(this.temporaryDate,o)}return g(f({},t),{showDateTitle:i})})}))}getCategoryFilters(){return this.filter?.categories.map(T).join(", ")}applyFilters(e){this.initiateExpenses().pipe(H(),h(this.destroySubject)).subscribe(()=>{e?.categories.length>0&&(this.expenses=this.expenses.filter(t=>e?.categories.includes(t.category))),e?.date&&(this.expenses=Q(this.expenses,e?.date?.start,e?.date?.finish)),this.sumValues()})}filterByCategory(e){this.filter=g(f({},this.filter),{categories:[e]}),this.applyFilters(this.filter)}getTotalAmountPerDay(e){return this.totalAmountPerDays.get(e)||0}onDelete(e){if(confirm("Delete?")){this.updateBalance(e);let t=this.expenses[e].id;this.expenseService.deleteExpense(t).pipe(A(()=>this.initiateExpenses()),h(this.destroySubject)).subscribe(()=>this.sumValues())}}updateBalance(e,t){let i=Number(localStorage.getItem("balance"))||0,s=j(this.expenses[e].category);if(i&&!this.expenses[e]?.isDeletedFromBalance&&s?.includeInBalance){let o=Math.round((i+this.expenses[e].amount)*100)/100;this.balanceService.addBalance(o).pipe(h(this.destroySubject)).subscribe()}t&&(this.expenses[e].isDeletedFromBalance=t,this.expenseService.updateExpense(this.expenses[e]).pipe(h(this.destroySubject)).subscribe())}onDeleteFromBalance(e){confirm("Return to balance?")&&this.updateBalance(e,!0)}onSwipeRight(){this.router.navigate(["/"])}showCategoryDetails(e){this.router.navigate(["/details"],{queryParams:{"category-id":e,"back-url":"/history"}})}isDatePanelVisible(e){return this.temporaryDate===0?(this.temporaryDate=e,!0):new Date(this.temporaryDate).toDateString()===new Date(e).toDateString()?!1:(this.temporaryDate=e,!0)}touchStartX=0;touchStartY=0;touchEndX=0;touchEndY=0;onTouchStart(e){this.touchStartX=e.changedTouches[0].screenX,this.touchStartY=e.changedTouches[0].screenY}onTouchEnd(e){this.touchEndX=e.changedTouches[0].screenX,this.touchEndY=e.changedTouches[0].screenY,this.handleSwipeGesture()}handleSwipeGesture(){let e=this.touchEndX-this.touchStartX,t=this.touchEndY-this.touchStartY;Math.abs(e)>Math.abs(t)&&(e>100?this.onSwipeRight():e<-100&&this.onSwipeLeft())}onSwipeLeft(){this.router.navigate(["/statistics"])}ngOnDestroy(){this.destroySubject.next(),this.destroySubject.complete()}sumValues(){this.totalAmount=this.expenses.reduce((e,t)=>{let i=e+t.amount;return Math.round(i*100)/100},0)}static \u0275fac=function(t){return new(t||n)(v(U),v(J),v(K),v(W))};static \u0275cmp=Y({type:n,selectors:[["app-history"]],hostBindings:function(t,i){t&1&&y("touchstart",function(o){return i.onTouchStart(o)})("touchend",function(o){return i.onTouchEnd(o)})},decls:8,vars:13,consts:[[1,"history-container"],[3,"routerLink"],[3,"selectedFilters","value","totalAmount"],["class","history-empty",4,"ngIf"],[4,"ngFor","ngForOf"],[1,"history-empty"],[3,"background","width","display",4,"ngIf"],[1,"history-item"],[1,"app-link",3,"click"],[3,"click"],[3,"color","cursor","click",4,"ngIf"]],template:function(t,i){t&1&&(a(0,"div",0)(1,"span",1),l(2,"< Back"),c(),d(3,"br"),a(4,"app-multi-filter",2),y("selectedFilters",function(o){return i.applyFilters(o)}),c(),d(5,"hr"),D(6,te,3,0,"div",3)(7,re,22,22,"span",4),c()),t&2&&(r(),p("color","blue")("cursor","pointer"),m("routerLink","/"),r(3),m("value",i.filter)("totalAmount",i.totalAmount),r(),p("background","#f8d7da")("height","2px"),r(),m("ngIf",!i.expenses.length),r(),m("ngForOf",i.expenses))},dependencies:[z,R,X,w,L],styles:[".history-container[_ngcontent-%COMP%]{height:100dvh;overflow-y:scroll}.history-container[_ngcontent-%COMP%]   .history-item[_ngcontent-%COMP%]{padding-left:10px}.history-container[_ngcontent-%COMP%]   .history-container-top[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:0 1rem 0 0}.history-container[_ngcontent-%COMP%]   .history-empty[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;font-family:Montserrat,sans-serif;color:#000}"]})};var oe=[{path:"",component:B}],I=class n{static \u0275fac=function(t){return new(t||n)};static \u0275mod=_({type:n});static \u0275inj=x({imports:[b.forChild(oe),b]})};var ee=class n{static \u0275fac=function(t){return new(t||n)};static \u0275mod=_({type:n});static \u0275inj=x({imports:[b,I,$,G,q,w]})};export{ee as HistoryModule};
